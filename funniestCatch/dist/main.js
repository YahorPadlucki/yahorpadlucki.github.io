var GameEvent={HOOK_ON_TOP:"HOOK_ON_TOP",FISH_CAUGHT:"FISH_CAUGHT",CLOSE_POPUP:"CLOSE_POPUP"},GameModel=function(){var t;return{getInstance:function(){return t||(t={ctx:"",doc:"",seaPositionY:150,engine:"",deep:"",score:0,device:"",maxDepth:2e3,maxFishes:20}),t}}}();DefaultMove=function(){function t(t,i){this.x=t,this.y=i,this.canvasWidth=GameModel.getInstance().ctx.canvas.width,this.moveDirection=-1,this.speed=Utils.randomRangeInt(45,80),this.angle=0}return t.prototype.move=function(t){this.x+=this.speed*t*this.moveDirection,(this.x<0||this.x>=this.canvasWidth)&&(this.speed=Utils.randomRangeInt(45,80),this.moveDirection*=-1,this.setPositionInBounds())},t.prototype.setPositionInBounds=function(){this.x<0&&(this.x=0),this.x>this.canvasWidth&&(this.x=this.canvasWidth),this.moveDirection>0?this.angle=180*Math.PI/180:this.angle=0},t}();var Popup=function(){function t(t){this.ctx=GameModel.getInstance().ctx,this.width=500,this.height=500,this.x=this.ctx.canvas.width/2,this.y=this.ctx.canvas.height/2,t&&(this.closeBtn=new Button(this.x,this.y+this.height/2)),this.text="",addEventListener(GameEvent.CLOSE_POPUP,this.onClose.bind(this))}return t.prototype.onClose=function(){this.isVisible=!1},t.prototype.show=function(t){this.isVisible=!0,this.text=t},t.prototype.draw=function(){this.isVisible&&this.drawPopup()},t.prototype.drawPopup=function(){this.ctx.beginPath(),this.ctx.fillStyle="#000000",this.ctx.fillRect(this.x-this.width/2,this.y-this.height/2,this.width,this.height),this.closeBtn&&this.closeBtn.draw(),this.fillTexts(),this.ctx.closePath()},t.prototype.fillTexts=function(){this.ctx.fillStyle="#ffffff",this.ctx.textBaseline="middle",this.ctx.textAlign="center",this.ctx.font='30px "Indie Flower"',this.ctx.fillText(this.text,this.x,this.y)},t}(),Boat=function(){function t(t,i,e){this.localX=t,this.localY=i,this.mousePosition=i,this.width=100,this.height=30,this.boatSpeed=3,this.x=this.localX,this.y=this.localY,this.hook=e,this.device=GameModel.getInstance().device,GameModel.getInstance().doc.addEventListener(this.device.event.move,this.onMouseMove.bind(this),!1),this.canvasWidth=GameModel.getInstance().ctx.canvas.width}return t.prototype.onMouseMove=function(t){var i=GameModel.getInstance().ctx.canvas,e=t.clientX-i.offsetLeft;this.device.isMobile&&(e=(t.touches[0]||t.changedTouches[0]).pageX-i.offsetLeft);e>0&&e<i.width&&(this.mousePosition=e)},t.prototype.onTouchMove=function(t){var i=GameModel.getInstance().ctx.canvas,e=t.clientX-i.offsetLeft;e>0&&e<i.width&&(this.mousePosition=e)},t.prototype.draw=function(){var t=GameModel.getInstance().ctx;t.beginPath(),t.moveTo(this.x-this.width/2,this.y-this.height),t.lineTo(this.x+this.width/2,this.y-this.height),t.lineTo(this.x+this.width/3,this.y),t.lineTo(this.x-this.width/3,this.y),t.lineTo(this.x-this.width/2,this.y-this.height),t.fillStyle="#000000",t.fill(),t.closePath()},t.prototype.update=function(t,i){this.localX+=(this.mousePosition-this.localX)*(this.boatSpeed*t),this.localX<0&&(this.localX=0),this.localX>this.canvasWidth&&(this.localX=this.canvasWidth),this.x=this.localX,this.y=this.localY-i,this.hook.update(t,this.x,i)},t}(),DeepMeter=function(){function t(){this.previousDepth=0,this.ctx=GameModel.getInstance().ctx}var i=10,e=15,s=10;return t.prototype.update=function(){var t=GameModel.getInstance().deep;this.previousDepth>0&&(this.previousDepth>=t?this.drawArrowUp():this.drawArrowDown()),this.ctx.beginPath(),this.ctx.fillStyle="#000000",this.ctx.textBaseline="top",this.ctx.textAlign="left",this.ctx.font='30px "Indie Flower"',this.ctx.fillText("Depth: "+t.toString(),15,0),this.previousDepth=t,this.ctx.closePath()},t.prototype.drawArrowDown=function(){this.ctx.beginPath(),this.ctx.fillStyle="#ff0000",this.ctx.fillRect(5,i,5,e),this.ctx.moveTo(0,25),this.ctx.lineTo(15,25),this.ctx.lineTo(7.5,35),this.ctx.lineTo(0,25),this.ctx.fill(),this.ctx.closePath()},t.prototype.drawArrowUp=function(){this.ctx.beginPath(),this.ctx.fillStyle="#ff0000",this.ctx.fillRect(5,20,5,e),this.ctx.moveTo(0,20),this.ctx.lineTo(15,20),this.ctx.lineTo(7.5,s),this.ctx.lineTo(0,20),this.ctx.fill(),this.ctx.closePath()},t}(),Hook=function(){function t(t,i){this.topPositionY=i,this.localX=t,this.localY=i,this.boatX=this.localX,this.width=5,this.height=15,this.hookSpeedX=25,this.hookSpeedY=100,this.cameraY=0,this.maxDepth=GameModel.getInstance().maxDepth,this.fishes=[],this.device=GameModel.getInstance().device,GameModel.getInstance().doc.addEventListener(this.device.event.down,this.onMouseDown.bind(this))}return t.prototype.onMouseDown=function(){if(!1!==this.goDown){this.goDown=!0;var t=new Event(GameEvent.CLOSE_POPUP);dispatchEvent(t),GameModel.getInstance().score=0}},t.prototype.draw=function(){var t=GameModel.getInstance().ctx;t.beginPath(),t.rect(this.x,this.y-this.height,this.width/2,this.height),t.fillStyle="#ff0000",t.fill(),t.closePath(),t.beginPath(),t.arc(this.x,this.y-5,5,.5*Math.PI,0,!0),t.fill(),t.closePath(),t.beginPath(),t.moveTo(this.boatX,this.topPositionY-this.cameraY-this.height),t.lineTo(this.x+1,this.y-this.height),t.lineWidth=1,t.stroke(),t.closePath(),this.drawFishes()},t.prototype.addFish=function(t){(t.angle=1.5708,this.fishes.length)?this.fishes[this.fishes.length-1].bodyWidth<t.bodyWidth&&this.fishes.push(t):this.fishes.push(t);this.goDown=!1,GameModel.getInstance().score++;var i=new Event(GameEvent.FISH_CAUGHT);dispatchEvent(i)},t.prototype.drawFishes=function(){if(this.fishes.length){var t=this.fishes[this.fishes.length-1];t.x=this.x,t.y=this.y,DrawUtils.drawFish(t)}},t.prototype.update=function(t,i,e){if(this.boatX=i,this.localY-this.height/2>GameModel.getInstance().seaPositionY?this.localX+=(i-this.localX)*(this.hookSpeedX*t):this.localX=i,this.goDown)this.localY+=this.hookSpeedY*t;else if(this.localY>this.topPositionY)this.localY-=this.hookSpeedY*t;else{if(0==this.goDown){var s=new Event(GameEvent.HOOK_ON_TOP);dispatchEvent(s)}this.localY=this.topPositionY,this.fishes=[],this.goDown=null}this.x=this.localX,this.y=this.localY-e,this.cameraY=e;var h=this.y+e-GameModel.getInstance().seaPositionY;h>=this.maxDepth&&(this.goDown=!1),GameModel.getInstance().deep=h.toFixed()},t}(),ScoreBoard=function(){function t(){}return t.prototype.update=function(){var t=GameModel.getInstance().ctx;t.beginPath(),t.fillStyle="#000000",t.textAlign="left",t.fillText("Score: "+GameModel.getInstance().score.toString(),10,50),t.closePath()},t}(),Sea=function(){function t(t){this.localY=t,this.ctx=GameModel.getInstance().ctx,this.height=0,this.y=this.localY}return t.prototype.draw=function(){this.ctx.beginPath(),this.ctx.rect(0,this.y,this.ctx.canvas.width,this.ctx.canvas.height+this.height),this.ctx.closePath();var t=GameModel.getInstance().deep/3e3*-80;this.ctx.fillStyle=Utils.shadeColor("#51DCFF",t),this.ctx.fill()},t.prototype.update=function(t,i){this.y=this.localY-i,this.height=this.ctx.canvas.height+i},t}(),Camera=function(){function t(){this.localX=0,this.localY=0,this.y=0,this.canvasHeight=GameModel.getInstance().ctx.canvas.height}return t.prototype.update=function(){this.objectToFollow&&(this.localY=this.objectToFollow.localY-this.canvasHeight/2,this.y=this.objectToFollow.y-this.canvasHeight/2,this.localY<0&&(this.localY=0,this.y=0))},t.prototype.setObjectToFollow=function(t){this.objectToFollow=t},t}(),Engine=function(t){var i=t.window,e=i.document,s=e.createElement("canvas"),h=s.getContext("2d");function o(){GameModel.getInstance().device.isMobile?(s.width=i.innerWidth,s.height=i.innerHeight):(s.width=600,s.height=600),GameModel.getInstance().ctx=h,GameModel.getInstance().doc=e,this.elementsToUpdate=[],this.elementsToDraw=[],this.camera=new Camera,e.body.appendChild(s)}return o.prototype.init=function(){this.prevTime=Date.now(),this.enterFrame()},o.prototype.removeFromUpdate=function(t){Utils.removeFromArray(this.elementsToUpdate,t)},o.prototype.removeFromDraw=function(t){Utils.removeFromArray(this.elementsToDraw,t)},o.prototype.enterFrame=function(){GameModel.getInstance().ctx.clearRect(0,0,h.canvas.width,h.canvas.height);var t=Date.now(),e=(t-this.prevTime)/1e3;this.draw(e),this.update(e),this.prevTime=t,i.requestAnimationFrame(this.enterFrame.bind(this))},o.prototype.update=function(t){for(var i=0;i<this.elementsToUpdate.length;i++)this.elementsToUpdate[i].update(t,this.camera.localY);this.camera.update(t)},o.prototype.draw=function(t){for(var i=0;i<this.elementsToDraw.length;i++){var e=this.elementsToDraw[i];e.y+e.height>=this.camera.y&&e.y-e.height<this.camera.y+s.height&&e.draw(t,this.camera.localY)}GameModel.getInstance().ctx.beginPath(),GameModel.getInstance().ctx.fillRect(0,this.camera.y+s.height-5,5,5)},o}(this),FishesManager=function(){function t(){this.fishes=[],this.engine=GameModel.getInstance().engine}function i(t,i){var e=new DefaultMove(t,i);return i>400&&(e=new EasingBehaviour(t,i)),i>800&&(e=new AccelerationMove(t,i)),i>1e3&&(e=new SineMove(t,i)),e}return t.prototype.checkCollisionWithHook=function(t){if(this.fishes.length)for(var i=this.fishes.length-1;i>=0;i--){var e=this.fishes[i];Utils.collidePointWithRotatedRectangle(t,e)&&(t.addFish(e),this.engine.removeFromUpdate(e),this.engine.removeFromDraw(e),this.fishes.splice(i,1))}},t.prototype.createFishes=function(){for(var t=GameModel.getInstance().ctx.canvas.width,e=0;e<GameModel.getInstance().maxFishes;e++){var s=Utils.randomRange(0,t),h=Utils.randomRange(50,150)*(e+1),o=GameModel.getInstance().seaPositionY+h,n=i(s,o),a=1,c=1,l=1;o>500&&(l=3),o>800&&(a=3),o>1e3&&(c=2);var r={widht:Utils.randomRangeInt(1,a),height:Utils.randomRangeInt(1,c),tail:Utils.randomRangeInt(1,l)},d=new Fish(s,o,n,r);this.engine.elementsToUpdate.push(d),this.engine.elementsToDraw.push(d),this.fishes.push(d),GameModel.getInstance().maxDepth=o+500}},t}(),TutorialManager=function(){var t=1;function i(){this.popup=new TutorialPopup,GameModel.getInstance().engine.elementsToDraw.push(this.popup),this.isMobile=GameModel.getInstance().device.isMobile;var t="Click to cast the line";this.isMobile&&(t="Tap to cast the line"),this.popup.show(t),addEventListener(GameEvent.CLOSE_POPUP,this.nextStep.bind(this)),addEventListener(GameEvent.FISH_CAUGHT,this.nextStep.bind(this)),addEventListener(GameEvent.HOOK_ON_TOP,this.nextStep.bind(this))}return i.prototype.nextStep=function(){if(!(++t>4))if(4!==t){var i,e,s=1e3;switch(t){case 2:i="Move mouse to avoid fish",this.isMobile&&(i="Touch and move to avoid fish"),e="On the way down",removeEventListener(GameEvent.CLOSE_POPUP,this.nextStep.bind(this));break;case 3:s=500,i="On the way up",e="Catch as many fish as you can",removeEventListener(GameEvent.FISH_CAUGHT,this.nextStep.bind(this))}setTimeout(this.popup.show(i,e),s)}else{var h=new Event(GameEvent.CLOSE_POPUP);dispatchEvent(h)}},i}(),TutorialPopup=function(){function t(){Popup.apply(this,arguments),this.height=100,this.width=400,this.y=this.ctx.canvas.height-this.height/2}return this.text1="",this.text2="",(t.prototype=Object.create(Popup.prototype)).show=function(t,i){this.isVisible=!0,this.text1=t,this.text2=i||""},t.prototype.fillTexts=function(){this.ctx.beginPath(),this.ctx.fillStyle="#ffffff",this.ctx.textBaseline="middle",this.ctx.textAlign="center",this.ctx.font='25px "Indie Flower"';var t=0;this.text2.length&&(t=20),this.ctx.fillText(this.text1,this.x,this.y-t),this.ctx.fillText(this.text2,this.x,this.y+t),this.ctx.closePath()},t}(),Device=function(){var t={click:"touchstart",down:"touchstart",up:"touchend",move:"touchmove",outside:"touchendoutside"},i={click:"click",down:"mousedown",up:"mouseup",move:"mousemove",outside:"mouseupoutside"};return function e(){/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)&&(e.prototype.isMobile=!0),e.prototype.event=e.prototype.isMobile?t:i}}(),DrawUtils=function(){function t(){}return t.drawFish=function(t){var i=GameModel.getInstance().ctx;i.save(),i.translate(t.x,t.y),i.rotate(t.angle),i.beginPath(),i.fillStyle=t.color;var e=-t.width/2+t.headWidth;i.arc(e,0,t.headWidth,1.57,-1.57,!1),i.fill(),i.beginPath(),i.fillRect(e,-t.bodyHeight/2,t.bodyWidth,t.bodyHeight),i.beginPath();var s=e+t.bodyWidth;i.moveTo(s,-t.bodyHeight/2),i.lineTo(s+t.tailWidth,t.bodyHeight/2),i.lineTo(s+t.tailWidth,-t.bodyHeight/2),i.lineTo(s,t.bodyHeight/2),i.fill(),i.closePath(),i.restore()},t}(),Utils=function(){function t(){}return t.randomRange=function(t,i){return Math.random()*(i-t)+t},t.randomRangeInt=function(t,i){return Math.floor(Math.random()*(i-t+1)+t)},t.distance=function(t,i){var e=t.x-i.x,s=t.y-i.y;return Math.sqrt(e*e+s*s)},t.getMousePos=function(t,i){var e=t.getBoundingClientRect();return{x:i.clientX-e.left,y:i.clientY-e.top}},t.isInside=function(t,i){return t.x>i.x&&t.x<i.x+i.width&&t.y<i.y+i.height&&t.y>i.y},t.getRandomColor=function(){for(var t="#",i=0;i<6;i++)t+="0123456789ABCDEF"[Math.floor(16*Math.random())];return t},t.removeFromArray=function(t,i){var e=t.indexOf(i);-1!=e&&t.splice(e,1)},t.shadeColor=function(t,i){var e=parseInt(t.slice(1),16),s=Math.round(2.55*i),h=(e>>16)+s,o=(e>>8&255)+s,n=(255&e)+s;return"#"+(16777216+65536*(h<255?h<1?0:h:255)+256*(o<255?o<1?0:o:255)+(n<255?n<1?0:n:255)).toString(16).slice(1)},t.collidePointWithRotatedRectangle=function(i,e){var s,h,o,n,a,c,l,r,d=e.x,p=e.y,u=d-e.width/2,f=p-e.height/2,x=t.rotatePoint(e,i,e.angle);return s=x.x<u?u:x.x>u+e.width?u+e.width:x.x,h=x.y<f?f:x.y>f+e.height?f+e.height:x.y,(o=x.x,n=x.y,a=s,c=h,l=Math.abs(o-a),r=Math.abs(n-c),Math.sqrt(l*l+r*r))<1},t.rgbToHex=function(t,i,e){if(t>255||i>255||e>255)throw"Invalid color component";return(t<<16|i<<8|e).toString(16)},t.rotatePoint=function(t,i,e){return{x:Math.round(Math.cos(e)*(i.x-t.x)-Math.sin(e)*(i.y-t.y)+t.x),y:Math.round(Math.sin(e)*(i.x-t.x)+Math.cos(e)*(i.y-t.y)+t.y)}},t.easeOutCubic=function(t,i,e,s){return e*(Math.pow(t/s-1,3)+1)+i},t.easeInSine=function(t,i,e,s){return-e*Math.cos(t/s*(Math.PI/2))+e+i},t.easeInQuad=function(t,i,e,s){return e*(t/=s)*t+i},t.easeInQuad=function(t,i,e,s){return(t/=s/2)<1?e/2*t*t*t+i:e/2*((t-=2)*t*t+2)+i},t}(),Fish=function(){var t=["#A52A2A","#FF7F50","#00008B","#006400","#FF1493","#C71585","#FF4500"];function i(i,e,s,h){this.bodyWidth=20*h.widht,this.bodyHeight=20*h.height,this.headWidth=this.bodyHeight/2,this.tailWidth=10*h.tail,this.width=this.headWidth+this.bodyWidth+this.tailWidth,this.height=this.bodyHeight,this.color=t[Math.floor(Math.random()*t.length)],this.y=e,this.moveBehaviour=s,this.angle=this.moveBehaviour.angle}return i.prototype.draw=function(){DrawUtils.drawFish(this)},i.prototype.drawVertices=function(){var t=GameModel.getInstance().ctx,i={x:this.x-this.width/2,y:this.y-this.height/2},e={x:this.x+this.width/2,y:this.y-this.height/2},s={x:this.x-this.width/2,y:this.y+this.height/2},h={x:this.x+this.width/2,y:this.y+this.height/2},o={x:this.x,y:this.y};i=Utils.rotatePoint(o,i,this.angle),e=Utils.rotatePoint(o,e,this.angle),s=Utils.rotatePoint(o,s,this.angle),h=Utils.rotatePoint(o,h,this.angle),t.beginPath(),t.rect(i.x,i.y,5,5),t.rect(e.x,e.y,5,5),t.rect(s.x,s.y,5,5),t.rect(h.x,h.y,5,5),t.closePath(),t.fillStyle="#ffffff",t.fill()},i.prototype.update=function(t,i){this.moveBehaviour.move(t),this.x=this.moveBehaviour.x,this.y=this.moveBehaviour.y-i,this.angle=this.moveBehaviour.angle,this.moveDirection=this.moveBehaviour.moveDirection},i}(),Button=function(){function t(t,i){GameModel.getInstance().doc.addEventListener("click",this.onMouseClicked.bind(this),!1),this.ctx=GameModel.getInstance().ctx,this.width=50,this.height=50,this.x=t-this.width/2,this.y=i-this.height}return t.prototype.onMouseClicked=function(t){var i=Utils.getMousePos(this.ctx.canvas,t);if(Utils.isInside(i,this)){var e=new Event(GameEvent.CLOSE_POPUP);dispatchEvent(e),console.log("clicked inside rect")}else console.log("clicked outside rect")},t.prototype.draw=function(){this.ctx.beginPath(),this.ctx.fillStyle="red",this.ctx.fillRect(this.x,this.y,this.width,this.height),this.ctx.fillStyle="#ffffff",this.ctx.textBaseline="middle",this.ctx.textAlign="center",this.ctx.font='30px "Indie Flower"',this.ctx.fillText("OK",this.x+this.width/2,this.y+this.width/2),this.ctx.closePath()},t}();AccelerationMove=function(){function t(t,i){DefaultMove.apply(this,arguments),this.initAcc=1.03,this.acc=this.initAcc}return(t.prototype=Object.create(DefaultMove.prototype)).move=function(t){(this.x<0||this.x>this.canvasWidth)&&(this.speed=Utils.randomRangeInt(45,80),this.moveDirection*=-1,this.acc=this.initAcc,this.setPositionInBounds()),this.acc+=.01,this.x+=this.speed*t*this.moveDirection*this.acc},t}(),EasingBehaviour=function(){function t(t,i){DefaultMove.apply(this,arguments),this.initX=t,this.iteration=0,this.angle=180*Math.PI/180,this.goalX=this.canvasWidth-this.initX,this.totalIterations=300*this.goalX/this.canvasWidth+1}return t.prototype.move=function(t){this.x=Utils.easeInQuad(this.iteration,this.initX,this.goalX,this.totalIterations),this.iteration+=100*t,(this.x<0||this.x>this.canvasWidth)&&this.setPositionInBounds()},t.prototype.setPositionInBounds=function(){this.iteration=0,this.totalIterations=500,this.x<0&&(this.x=0,this.initX=0,this.goalX=this.canvasWidth,this.angle=180*Math.PI/180),this.x>this.canvasWidth&&(this.angle=0,this.x=this.canvasWidth,this.initX=this.canvasWidth,this.goalX=-this.canvasWidth)},t}(),SineMove=function(){function t(t,i){DefaultMove.apply(this,arguments),this.initPositionY=i,this.prevX=this.x=t,this.prevY=this.y=i}return(t.prototype=Object.create(DefaultMove.prototype)).move=function(t){(this.x<0||this.x>=this.canvasWidth)&&(this.speed=Utils.randomRangeInt(45,80),this.moveDirection*=-1,this.setPositionInBounds()),this.x+=this.speed*t*this.moveDirection,this.y=50*Math.sin(this.x/20)+this.initPositionY,this.dirX=this.prevX-this.x,this.dirY=this.prevY-this.y,this.angle=Math.atan2(this.dirY,this.dirX),this.prevX=this.x,this.prevY=this.y},t}();var FinalPopup=function(){function t(){Popup.apply(this,arguments),this.height=150,this.width=400,this.y=this.ctx.canvas.height/2}return(t.prototype=Object.create(Popup.prototype)).fillTexts=function(){this.ctx.fillStyle="#ffffff",this.ctx.textBaseline="middle",this.ctx.textAlign="center",this.ctx.font='30px "Indie Flower"',this.ctx.fillText("Your Score",this.x,this.y-30),this.ctx.fillText(GameModel.getInstance().score,this.x,this.y+10)},t}(),Game=function(){function t(){GameModel.getInstance().device=new Device;var t=new Engine;t.init(),GameModel.getInstance().engine=t;var i=GameModel.getInstance().ctx,e=GameModel.getInstance().seaPositionY,s=i.canvas.width/2,h=new Sea(e);t.elementsToUpdate.push(h),t.elementsToDraw.push(h),this.deepMeter=new DeepMeter,t.elementsToUpdate.push(this.deepMeter),this.scoreBoard=new ScoreBoard,t.elementsToUpdate.push(this.scoreBoard),this.fishesManager=new FishesManager,this.fishesManager.createFishes(),this.hook=new Hook(s,e),this.boat=new Boat(s,e,this.hook),t.elementsToUpdate.push(this.boat),t.elementsToDraw.push(this.boat),t.elementsToDraw.push(this.hook),new TutorialManager,t.camera.setObjectToFollow(this.boat.hook),t.elementsToUpdate.push(this),addEventListener(GameEvent.HOOK_ON_TOP,this.showFinalScore.bind(this)),this.finalPopup=new FinalPopup,t.elementsToDraw.push(this.finalPopup)}return t.prototype.showFinalScore=function(){this.finalPopup.show()},t.prototype.update=function(){this.fishesManager.checkCollisionWithHook(this.boat.hook)},t}();new Game;